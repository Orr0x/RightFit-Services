generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id                     String                 @id @default(uuid())
  tenant_name            String                 @db.VarChar(100)
  subscription_status    SubscriptionStatus     @default(TRIAL)
  trial_ends_at          DateTime?
  created_at             DateTime               @default(now())
  updated_at             DateTime               @updatedAt
  certificates           Certificate[]
  contractors            Contractor[]
  devices                Device[]
  financial_transactions FinancialTransaction[]
  notifications          Notification[]
  photos                 Photo[]
  properties             Property[]
  property_budgets       PropertyBudget[]
  shared_properties      PropertyShare[]        @relation("SharedProperties")
  received_properties    PropertyShare[]        @relation("ReceivedProperties")
  property_tenants       PropertyTenant[]
  service_provider       ServiceProvider?
  users                  User[]
  work_orders            WorkOrder[]

  @@map("tenants")
}

model User {
  id                 String         @id @default(uuid())
  tenant_id          String
  email              String         @unique @db.VarChar(255)
  password_hash      String         @db.VarChar(255)
  full_name          String         @db.VarChar(100)
  role               UserRole       @default(ADMIN)
  created_at         DateTime       @default(now())
  updated_at         DateTime       @updatedAt
  deleted_at         DateTime?
  contractor_profile Contractor?    @relation("ContractorUser")
  devices            Device[]
  notifications      Notification[]
  photos_uploaded    Photo[]        @relation("PhotoUploader")
  properties         Property[]     @relation("PropertyOwner")
  tenant             Tenant         @relation(fields: [tenant_id], references: [id])
  work_orders        WorkOrder[]    @relation("WorkOrderCreator")

  @@index([tenant_id])
  @@index([email])
  @@map("users")
}

model PasswordResetToken {
  id         String    @id @default(uuid())
  user_id    String
  token      String    @unique
  expires_at DateTime
  used_at    DateTime?
  created_at DateTime  @default(now())

  @@index([token])
  @@index([user_id])
  @@map("password_reset_tokens")
}

model Property {
  id                     String                 @id @default(uuid())
  tenant_id              String
  owner_user_id          String
  name                   String                 @db.VarChar(100)
  address_line1          String                 @db.VarChar(255)
  address_line2          String?                @db.VarChar(255)
  city                   String                 @db.VarChar(100)
  postcode               String                 @db.VarChar(10)
  property_type          PropertyType
  bedrooms               Int                    @default(0)
  bathrooms              Int                    @default(0)
  access_instructions    String?
  status                 PropertyStatus         @default(ACTIVE)
  created_at             DateTime               @default(now())
  updated_at             DateTime               @updatedAt
  deleted_at             DateTime?
  certificates           Certificate[]
  financial_transactions FinancialTransaction[]
  photos                 Photo[]
  owner                  User                   @relation("PropertyOwner", fields: [owner_user_id], references: [id])
  tenant                 Tenant                 @relation(fields: [tenant_id], references: [id])
  property_budget        PropertyBudget?
  shares                 PropertyShare[]
  property_tenants       PropertyTenant[]
  work_orders            WorkOrder[]

  @@index([tenant_id])
  @@index([owner_user_id])
  @@index([postcode])
  @@index([tenant_id, deleted_at])
  @@map("properties")
}

model WorkOrder {
  id                  String            @id @default(uuid())
  tenant_id           String
  property_id         String
  contractor_id       String?
  created_by_user_id  String
  title               String            @db.VarChar(255)
  description         String?
  status              WorkOrderStatus   @default(OPEN)
  priority            WorkOrderPriority @default(MEDIUM)
  category            WorkOrderCategory @default(OTHER)
  due_date            DateTime?
  estimated_cost      Decimal?          @db.Decimal(10, 2)
  actual_cost         Decimal?          @db.Decimal(10, 2)
  started_at          DateTime?
  completed_at        DateTime?
  completion_note     String?           @db.VarChar(500)
  cancellation_reason String?           @db.VarChar(500)
  created_at          DateTime          @default(now())
  updated_at          DateTime          @updatedAt
  deleted_at          DateTime?
  photos              Photo[]
  contractor          Contractor?       @relation(fields: [contractor_id], references: [id])
  created_by          User              @relation("WorkOrderCreator", fields: [created_by_user_id], references: [id])
  property            Property          @relation(fields: [property_id], references: [id])
  tenant              Tenant            @relation(fields: [tenant_id], references: [id])

  @@index([tenant_id])
  @@index([property_id])
  @@index([contractor_id])
  @@index([status])
  @@index([priority])
  @@index([due_date])
  @@map("work_orders")
}

model Contractor {
  id           String      @id @default(uuid())
  tenant_id    String
  user_id      String?     @unique
  name         String      @db.VarChar(100)
  trade        String      @db.VarChar(50)
  company_name String?     @db.VarChar(100)
  phone        String      @db.VarChar(20)
  email        String?     @db.VarChar(255)
  notes        String?     @db.VarChar(500)
  sms_opt_out  Boolean     @default(false)
  created_at   DateTime    @default(now())
  updated_at   DateTime    @updatedAt
  deleted_at   DateTime?
  tenant       Tenant      @relation(fields: [tenant_id], references: [id])
  user         User?       @relation("ContractorUser", fields: [user_id], references: [id])
  work_orders  WorkOrder[]

  @@index([tenant_id])
  @@index([user_id])
  @@index([tenant_id, trade])
  @@map("contractors")
}

model Photo {
  id                    String      @id @default(uuid())
  tenant_id             String
  uploaded_by_user_id   String
  property_id           String?
  work_order_id         String?
  s3_key                String      @db.VarChar(255)
  s3_url                String      @db.VarChar(500)
  thumbnail_url         String      @db.VarChar(500)
  file_size             Int
  mime_type             String      @db.VarChar(50)
  width                 Int
  height                Int
  label                 PhotoLabel?
  caption               String?
  gps_latitude          Decimal?    @db.Decimal(10, 8)
  gps_longitude         Decimal?    @db.Decimal(11, 8)
  quality_check_passed  Boolean?
  quality_check_details Json?
  created_at            DateTime    @default(now())
  property              Property?   @relation(fields: [property_id], references: [id])
  tenant                Tenant      @relation(fields: [tenant_id], references: [id])
  uploaded_by           User        @relation("PhotoUploader", fields: [uploaded_by_user_id], references: [id])
  work_order            WorkOrder?  @relation(fields: [work_order_id], references: [id])

  @@index([tenant_id])
  @@index([property_id])
  @@index([work_order_id])
  @@index([created_at])
  @@map("photos")
}

model Certificate {
  id                 String          @id @default(uuid())
  tenant_id          String
  property_id        String
  certificate_type   CertificateType
  issue_date         DateTime
  expiry_date        DateTime
  document_url       String          @db.VarChar(500)
  certificate_number String?         @db.VarChar(100)
  issuer_name        String?         @db.VarChar(100)
  notes              String?
  created_at         DateTime        @default(now())
  updated_at         DateTime        @updatedAt
  deleted_at         DateTime?
  property           Property        @relation(fields: [property_id], references: [id])
  tenant             Tenant          @relation(fields: [tenant_id], references: [id])

  @@index([tenant_id])
  @@index([property_id])
  @@index([expiry_date])
  @@index([certificate_type])
  @@map("certificates")
}

model Device {
  id            String         @id @default(uuid())
  user_id       String
  tenant_id     String
  push_token    String         @db.VarChar(255)
  device_id     String         @db.VarChar(255)
  platform      DevicePlatform
  is_active     Boolean        @default(true)
  registered_at DateTime       @default(now())
  tenant        Tenant         @relation(fields: [tenant_id], references: [id])
  user          User           @relation(fields: [user_id], references: [id])

  @@unique([device_id, user_id])
  @@index([user_id])
  @@index([tenant_id])
  @@map("devices")
}

model Notification {
  id                String           @id @default(uuid())
  user_id           String
  tenant_id         String
  notification_type NotificationType
  title             String           @db.VarChar(255)
  body              String
  data              Json?
  sent_at           DateTime         @default(now())
  read_at           DateTime?
  tenant            Tenant           @relation(fields: [tenant_id], references: [id])
  user              User             @relation(fields: [user_id], references: [id])

  @@index([user_id, read_at])
  @@index([tenant_id])
  @@map("notifications")
}

model PropertyTenant {
  id                String        @id @default(uuid())
  tenant_id         String
  property_id       String
  name              String        @db.VarChar(100)
  email             String?       @db.VarChar(255)
  phone             String?       @db.VarChar(20)
  move_in_date      DateTime
  lease_expiry_date DateTime?
  rent_amount       Decimal       @db.Decimal(10, 2)
  rent_frequency    RentFrequency
  rent_due_day      Int?
  status            TenantStatus  @default(ACTIVE)
  notes             String?
  created_at        DateTime      @default(now())
  updated_at        DateTime      @updatedAt
  deleted_at        DateTime?
  property          Property      @relation(fields: [property_id], references: [id])
  tenant            Tenant        @relation(fields: [tenant_id], references: [id])
  rent_payments     RentPayment[]

  @@index([tenant_id])
  @@index([property_id])
  @@index([status])
  @@index([lease_expiry_date])
  @@map("property_tenants")
}

model RentPayment {
  id                 String         @id @default(uuid())
  property_tenant_id String
  amount             Decimal        @db.Decimal(10, 2)
  payment_date       DateTime
  expected_date      DateTime?
  payment_method     PaymentMethod?
  reference          String?        @db.VarChar(100)
  notes              String?
  created_at         DateTime       @default(now())
  property_tenant    PropertyTenant @relation(fields: [property_tenant_id], references: [id])

  @@index([property_tenant_id])
  @@index([payment_date])
  @@index([expected_date])
  @@map("rent_payments")
}

model FinancialTransaction {
  id          String           @id @default(uuid())
  tenant_id   String
  property_id String
  type        TransactionType
  category    ExpenseCategory?
  amount      Decimal          @db.Decimal(10, 2)
  date        DateTime
  description String           @db.VarChar(500)
  receipt_url String?          @db.VarChar(500)
  notes       String?
  created_at  DateTime         @default(now())
  updated_at  DateTime         @updatedAt
  deleted_at  DateTime?
  property    Property         @relation(fields: [property_id], references: [id])
  tenant      Tenant           @relation(fields: [tenant_id], references: [id])

  @@index([tenant_id])
  @@index([property_id])
  @@index([type])
  @@index([date])
  @@index([category])
  @@map("financial_transactions")
}

model PropertyBudget {
  id              String   @id @default(uuid())
  tenant_id       String
  property_id     String   @unique
  monthly_budget  Decimal  @db.Decimal(10, 2)
  alert_threshold Decimal  @default(0.8) @db.Decimal(3, 2)
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt
  property        Property @relation(fields: [property_id], references: [id])
  tenant          Tenant   @relation(fields: [tenant_id], references: [id])

  @@index([tenant_id])
  @@map("property_budgets")
}

model ServiceProvider {
  id                   String               @id @default(uuid())
  business_name        String               @db.VarChar(100)
  owner_name           String               @db.VarChar(100)
  email                String               @db.VarChar(255)
  phone                String               @db.VarChar(20)
  address              String?
  created_at           DateTime             @default(now())
  updated_at           DateTime             @updatedAt
  tenant_id            String               @unique(map: "service_providers_tenant_id_unique") @db.VarChar(255)
  checklist_templates  ChecklistTemplate[]
  customers            Customer[]
  external_contractors ExternalContractor[]
  tenant               Tenant               @relation(fields: [tenant_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  services             Service[]
  workers              Worker[]

  @@index([tenant_id])
  @@map("service_providers")
}

model Service {
  id                  String           @id @default(uuid())
  service_provider_id String
  service_type        ServiceType
  name                String           @db.VarChar(100)
  description         String?
  pricing_model       PricingModel
  default_rate        Decimal          @db.Decimal(10, 2)
  is_active           Boolean          @default(true)
  created_at          DateTime         @default(now())
  updated_at          DateTime         @updatedAt
  cleaning_jobs       CleaningJob[]
  maintenance_jobs    MaintenanceJob[]
  service_provider    ServiceProvider  @relation(fields: [service_provider_id], references: [id])

  @@index([service_provider_id])
  @@index([service_type])
  @@map("services")
}

model Customer {
  id                          String               @id @default(uuid())
  customer_number             String?              @unique @db.VarChar(50)
  service_provider_id         String
  business_name               String               @db.VarChar(100)
  contact_name                String               @db.VarChar(100)
  email                       String               @db.VarChar(255)
  phone                       String               @db.VarChar(20)
  // Legacy address fields (deprecated - kept for backwards compatibility)
  address                     String?
  address_line1               String?              @db.VarChar(255)
  address_line2               String?              @db.VarChar(255)
  city                        String?              @db.VarChar(100)
  postcode                    String?              @db.VarChar(20)
  country                     String?              @db.VarChar(100)
  // Business address
  business_address_line1      String?              @db.VarChar(255)
  business_address_line2      String?              @db.VarChar(255)
  business_city               String?              @db.VarChar(100)
  business_postcode           String?              @db.VarChar(20)
  business_country            String?              @db.VarChar(100)
  // Contact address (if different from business)
  contact_address_different   Boolean              @default(false)
  contact_address_line1       String?              @db.VarChar(255)
  contact_address_line2       String?              @db.VarChar(255)
  contact_city                String?              @db.VarChar(100)
  contact_postcode            String?              @db.VarChar(20)
  contact_country             String?              @db.VarChar(100)
  // Customer details
  customer_type               CustomerType
  has_cleaning_contract       Boolean              @default(false)
  has_maintenance_contract    Boolean              @default(false)
  bundled_discount_percentage Decimal              @default(0) @db.Decimal(5, 2)
  payment_terms               PaymentTerms         @default(NET_14)
  payment_reliability_score   Int                  @default(50)
  satisfaction_score          Int?
  cross_sell_potential        String               @default("MEDIUM") @db.VarChar(20)
  created_at                  DateTime             @default(now())
  updated_at                  DateTime             @updatedAt
  checklist_templates         ChecklistTemplate[]
  cleaning_jobs               CleaningJob[]
  cleaning_contracts          CleaningContract[]
  cleaning_invoices           CleaningInvoice[]
  cleaning_quotes             CleaningQuote[]
  customer_properties         CustomerProperty[]
  service_provider            ServiceProvider      @relation(fields: [service_provider_id], references: [id])
  maintenance_jobs            MaintenanceJob[]
  quotes                      Quote[]
  invoices                    Invoice[]
  portal_user                 CustomerPortalUser?
  preferences                 CustomerPreferences?
  worker_issue_reports        WorkerIssueReport[]

  @@index([service_provider_id])
  @@map("customers")
}

model CustomerProperty {
  id                             String                         @id @default(uuid())
  customer_id                    String
  property_name                  String                         @db.VarChar(100)
  address                        String
  postcode                       String                         @db.VarChar(10)
  property_type                  String                         @db.VarChar(50)
  bedrooms                       Int                            @default(0)
  bathrooms                      Int                            @default(0)
  access_instructions            String?
  access_code                    String?                        @db.VarChar(255)
  cleaning_checklist_template_id String?
  guest_portal_enabled           Boolean                        @default(false)
  guest_portal_qr_code_url       String?                        @db.VarChar(500)
  is_active                      Boolean                        @default(true)
  // Enhanced property details for service providers
  photo_urls                     Json? // Array of photo URLs [{url, caption, type}]
  utility_locations              Json? // {stopTap, waterMeter, gasMeter, fuseBox, etc.}
  emergency_contacts             Json? // Array of emergency contacts [{name, phone, relation}]
  cleaner_notes                  String? // General notes for cleaners
  wifi_ssid                      String?                        @db.VarChar(100)
  wifi_password                  String?                        @db.VarChar(100)
  parking_info                   String? // Where to park
  pet_info                       String? // Info about pets
  special_requirements           String? // Any special requirements or sensitivities
  created_at                     DateTime                       @default(now())
  updated_at                     DateTime                       @updatedAt
  cleaning_jobs                  CleaningJob[]
  cleaning_quotes                CleaningQuote[]
  contract_properties            ContractProperty[]
  property_checklists            PropertyChecklistTemplate[]
  customer                       Customer                       @relation(fields: [customer_id], references: [id])
  guest_issue_reports            GuestIssueReport[]
  worker_issue_reports           WorkerIssueReport[]
  maintenance_jobs               MaintenanceJob[]
  guest_sessions                 GuestSession[]
  knowledge_base                 PropertyKnowledgeBase[]
  property_calendars             PropertyCalendar[]

  @@index([customer_id])
  @@index([postcode])
  @@map("customer_properties")
}

model Worker {
  id                       String                 @id @default(uuid())
  service_provider_id      String
  user_id                  String?
  first_name               String                 @db.VarChar(100)
  last_name                String                 @db.VarChar(100)
  email                    String                 @db.VarChar(255)
  phone                    String                 @db.VarChar(20)
  // Address fields
  address_street           String?                @db.VarChar(255)
  address_city             String?                @db.VarChar(100)
  address_postcode         String?                @db.VarChar(20)
  address_country          String?                @db.VarChar(100)
  // Employment fields
  worker_type              WorkerType
  employment_type          EmploymentType
  hourly_rate              Decimal                @db.Decimal(10, 2)
  is_active                Boolean                @default(true)
  max_weekly_hours         Int?
  employment_start_date    DateTime?              @db.Date
  // Legal/Compliance fields
  date_of_birth            DateTime?              @db.Date
  ni_number                String?                @db.VarChar(20) // National Insurance Number
  driving_licence_number   String?                @db.VarChar(50)
  driving_licence_expiry   DateTime?              @db.Date
  // Professional fields
  bio                      String?                @db.Text
  skills                   String[]               @db.VarChar(100) // Array of skills
  experience_years         Int?
  // Emergency contact
  emergency_contact_name   String?                @db.VarChar(100)
  emergency_contact_phone  String?                @db.VarChar(20)
  emergency_contact_relation String?              @db.VarChar(50)
  // Performance metrics
  jobs_completed           Int                    @default(0)
  average_rating           Decimal?               @db.Decimal(3, 2)
  // Media
  photo_url                String?                @db.Text
  // Timestamps
  created_at               DateTime               @default(now())
  updated_at               DateTime               @updatedAt
  // Relations
  certificates             WorkerCertificate[]
  cleaning_jobs            CleaningJob[]
  cleaning_timesheets      CleaningJobTimesheet[]
  maintenance_jobs         MaintenanceJob[]
  history                  WorkerHistory[]
  availability             WorkerAvailability[]
  issue_reports            WorkerIssueReport[]
  service_provider         ServiceProvider        @relation(fields: [service_provider_id], references: [id])

  @@index([service_provider_id])
  @@index([worker_type])
  @@index([service_provider_id, is_active])
  @@index([email])
  @@map("workers")
}

model WorkerCertificate {
  id          String    @id @default(uuid())
  worker_id   String
  name        String    @db.VarChar(255)
  file_url    String    @db.Text
  s3_key      String    @db.Text
  file_type   String    @db.VarChar(50)
  file_size   Int
  expiry_date DateTime?
  uploaded_at DateTime  @default(now())
  updated_at  DateTime  @updatedAt
  worker      Worker    @relation(fields: [worker_id], references: [id], onDelete: Cascade)

  @@index([worker_id])
  @@index([expiry_date])
  @@map("worker_certificates")
}

model WorkerAvailability {
  id         String   @id @default(uuid())
  worker_id  String
  start_date DateTime @db.Date
  end_date   DateTime @db.Date
  reason     String?  @db.VarChar(255)
  status     WorkerAvailabilityStatus @default(BLOCKED)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  worker     Worker   @relation(fields: [worker_id], references: [id], onDelete: Cascade)

  @@index([worker_id])
  @@index([start_date])
  @@index([end_date])
  @@index([status])
  @@map("worker_availability")
}

model ExternalContractor {
  id                          String           @id @default(uuid())
  service_provider_id         String
  company_name                String           @db.VarChar(100)
  contact_name                String           @db.VarChar(100)
  email                       String           @db.VarChar(255)
  phone                       String           @db.VarChar(20)
  specialties                 String[]         @db.VarChar(50)
  certifications              String[]         @db.VarChar(255)
  referral_fee_percentage     Decimal          @default(0) @db.Decimal(5, 2)
  preferred_contractor        Boolean          @default(false)
  emergency_callout_available Boolean          @default(false)
  jobs_completed              Int              @default(0)
  average_response_time_hours Decimal?         @db.Decimal(10, 2)
  average_rating              Decimal?         @db.Decimal(3, 2)
  created_at                  DateTime         @default(now())
  updated_at                  DateTime         @updatedAt
  service_provider            ServiceProvider  @relation(fields: [service_provider_id], references: [id])
  maintenance_jobs            MaintenanceJob[]

  @@index([service_provider_id])
  @@map("external_contractors")
}

model CleaningJob {
  id                           String                 @id @default(uuid())
  service_id                   String?
  property_id                  String
  customer_id                  String
  contract_id                  String?
  assigned_worker_id           String?
  quote_id                     String?
  scheduled_date               DateTime?              @db.Date
  scheduled_start_time         String?                @db.VarChar(10)
  scheduled_end_time           String?                @db.VarChar(10)
  actual_start_time            DateTime?
  actual_end_time              DateTime?
  checklist_template_id        String?
  checklist_items              Json?
  checklist_completed_items    Int                    @default(0)
  checklist_total_items        Int                    @default(0)
  status                       JobStatus              @default(PENDING)
  completion_notes             String?
  worker_notes                 String? // Worker notes for pre-job documentation and observations
  job_note_photos              String[]               @default([]) @db.VarChar(500) // Photos for pre-job documentation
  before_photos                String[]               @db.VarChar(500)
  after_photos                 String[]               @db.VarChar(500)
  issue_photos                 String[]               @db.VarChar(500)
  pricing_type                 String                 @db.VarChar(50)
  quoted_price                 Decimal                @db.Decimal(10, 2)
  actual_price                 Decimal?               @db.Decimal(10, 2)
  maintenance_issues_found     Int                    @default(0)
  maintenance_quotes_generated Int                    @default(0)
  created_at                   DateTime               @default(now())
  updated_at                   DateTime               @updatedAt
  assigned_worker              Worker?                @relation(fields: [assigned_worker_id], references: [id])
  contract                     CleaningContract?      @relation(fields: [contract_id], references: [id])
  customer                     Customer               @relation(fields: [customer_id], references: [id])
  property                     CustomerProperty       @relation(fields: [property_id], references: [id])
  service                      Service?               @relation(fields: [service_id], references: [id])
  maintenance_jobs             MaintenanceJob[]
  worker_issue_reports         WorkerIssueReport[]
  timesheets                   CleaningJobTimesheet[]
  history                      CleaningJobHistory[]

  @@index([service_id])
  @@index([property_id])
  @@index([customer_id])
  @@index([contract_id])
  @@index([assigned_worker_id])
  @@index([status])
  @@index([scheduled_date])
  @@index([status, scheduled_date])
  @@index([customer_id, status])
  @@index([assigned_worker_id, status])
  @@map("cleaning_jobs")
}

model MaintenanceJob {
  id                           String              @id @default(uuid())
  service_id                   String
  property_id                  String
  customer_id                  String
  assigned_worker_id           String?
  assigned_contractor_id       String?
  source                       MaintenanceSource
  source_cleaning_job_id       String?
  source_guest_report_id       String?
  category                     String              @db.VarChar(50)
  priority                     MaintenancePriority
  title                        String              @db.VarChar(255)
  description                  String?
  requested_date               DateTime?           @db.Date
  scheduled_date               DateTime?           @db.Date
  scheduled_start_time         String?             @db.VarChar(5)
  scheduled_end_time           String?             @db.VarChar(5)
  completed_date               DateTime?           @db.Date
  status                       MaintenanceStatus   @default(QUOTE_PENDING)
  quote_id                     String?
  estimated_hours              Decimal?            @db.Decimal(10, 2)
  estimated_parts_cost         Decimal?            @db.Decimal(10, 2)
  estimated_labor_cost         Decimal?            @db.Decimal(10, 2)
  estimated_total              Decimal?            @db.Decimal(10, 2)
  actual_total                 Decimal?            @db.Decimal(10, 2)
  issue_photos                 String[]            @db.VarChar(500)
  work_in_progress_photos      String[]            @db.VarChar(500)
  completion_photos            String[]            @db.VarChar(500)
  ai_severity_score            Int?
  ai_category_confidence       Decimal?            @db.Decimal(3, 2)
  completion_notes             String?
  customer_satisfaction_rating Int?
  created_at                   DateTime            @default(now())
  updated_at                   DateTime            @updatedAt
  assigned_contractor          ExternalContractor? @relation(fields: [assigned_contractor_id], references: [id])
  assigned_worker              Worker?             @relation(fields: [assigned_worker_id], references: [id])
  customer                     Customer            @relation(fields: [customer_id], references: [id])
  property                     CustomerProperty    @relation(fields: [property_id], references: [id])
  quote                        Quote?              @relation(fields: [quote_id], references: [id])
  service                      Service             @relation(fields: [service_id], references: [id])
  source_cleaning_job          CleaningJob?        @relation(fields: [source_cleaning_job_id], references: [id])
  source_guest_report          GuestIssueReport?   @relation(fields: [source_guest_report_id], references: [id])
  worker_issue_reports         WorkerIssueReport[] @relation("WorkerIssueMaintenanceJob")
  guest_issues                 GuestIssue[]
  invoice                      Invoice?

  @@index([service_id])
  @@index([property_id])
  @@index([customer_id])
  @@index([assigned_worker_id])
  @@index([assigned_contractor_id])
  @@index([status])
  @@index([priority])
  @@index([scheduled_date])
  @@index([customer_id, status])
  @@index([assigned_worker_id, status])
  @@index([property_id, scheduled_date])
  @@map("maintenance_jobs")
}

model Quote {
  id                  String           @id @default(uuid())
  customer_id         String
  maintenance_job_id  String?
  quote_number        String           @unique @db.VarChar(50)
  quote_date          DateTime         @db.Date
  valid_until_date    DateTime         @db.Date
  line_items          Json
  subtotal            Decimal          @db.Decimal(10, 2)
  discount_percentage Decimal          @default(0) @db.Decimal(5, 2)
  discount_amount     Decimal          @default(0) @db.Decimal(10, 2)
  total               Decimal          @db.Decimal(10, 2)
  status              QuoteStatus      @default(DRAFT)
  customer_response   String?
  approved_at         DateTime?
  approved_by         String?          @db.VarChar(100)
  created_at          DateTime         @default(now())
  updated_at          DateTime         @updatedAt
  maintenance_jobs    MaintenanceJob[]
  customer            Customer         @relation(fields: [customer_id], references: [id])

  @@index([customer_id])
  @@index([status])
  @@map("quotes")
}

model Invoice {
  id                 String          @id @default(uuid())
  customer_id        String
  maintenance_job_id String?         @unique
  cleaning_job_id    String?         @unique
  invoice_number     String          @unique @db.VarChar(50)
  invoice_date       DateTime        @db.Date
  due_date           DateTime        @db.Date
  line_items         Json
  subtotal           Decimal         @db.Decimal(10, 2)
  tax_percentage     Decimal         @default(20) @db.Decimal(5, 2)
  tax_amount         Decimal         @db.Decimal(10, 2)
  total              Decimal         @db.Decimal(10, 2)
  status             InvoiceStatus   @default(PENDING)
  payment_method     String?         @db.VarChar(50)
  paid_at            DateTime?
  payment_reference  String?         @db.VarChar(100)
  notes              String?
  created_at         DateTime        @default(now())
  updated_at         DateTime        @updatedAt
  customer           Customer        @relation(fields: [customer_id], references: [id])
  maintenance_job    MaintenanceJob? @relation(fields: [maintenance_job_id], references: [id])

  @@index([customer_id])
  @@index([status])
  @@index([invoice_date])
  @@map("invoices")
}

model ChecklistTemplate {
  id                         String                         @id @default(uuid())
  service_provider_id        String
  customer_id                String?
  template_name              String                         @db.VarChar(100)
  property_type              String                         @db.VarChar(50)
  sections                   Json
  estimated_duration_minutes Int
  is_active                  Boolean                        @default(true)
  created_at                 DateTime                       @default(now())
  updated_at                 DateTime                       @updatedAt
  customer                   Customer?                      @relation(fields: [customer_id], references: [id])
  service_provider           ServiceProvider                @relation(fields: [service_provider_id], references: [id])
  property_checklists        PropertyChecklistTemplate[]

  @@index([service_provider_id])
  @@index([customer_id])
  @@map("checklist_templates")
}

model PropertyChecklistTemplate {
  id                     String              @id @default(uuid())
  property_id            String
  checklist_template_id  String
  created_at             DateTime            @default(now())
  property               CustomerProperty    @relation(fields: [property_id], references: [id], onDelete: Cascade)
  checklist_template     ChecklistTemplate   @relation(fields: [checklist_template_id], references: [id], onDelete: Cascade)

  @@unique([property_id, checklist_template_id])
  @@index([property_id])
  @@index([checklist_template_id])
  @@map("property_checklist_templates")
}

model GuestIssueReport {
  id                         String           @id @default(uuid())
  property_id                String
  guest_name                 String?          @db.VarChar(100)
  guest_phone                String?          @db.VarChar(20)
  guest_email                String?          @db.VarChar(255)
  issue_type                 String           @db.VarChar(50)
  issue_description          String
  photos                     String[]         @db.VarChar(500)
  ai_severity                String?          @db.VarChar(20)
  ai_category                String?          @db.VarChar(50)
  ai_confidence              Decimal?         @db.Decimal(3, 2)
  ai_analysis_notes          String?
  status                     GuestIssueStatus @default(SUBMITTED)
  created_maintenance_job_id String?
  assigned_to_next_cleaning  Boolean          @default(false)
  guest_notified             Boolean          @default(false)
  guest_notification_message String?
  reported_at                DateTime         @default(now())
  triaged_at                 DateTime?
  resolved_at                DateTime?
  created_at                 DateTime         @default(now())
  updated_at                 DateTime         @updatedAt
  property                   CustomerProperty @relation(fields: [property_id], references: [id])
  maintenance_jobs           MaintenanceJob[]

  @@index([property_id])
  @@index([status])
  @@map("guest_issue_reports")
}

model WorkerIssueReport {
  id                         String              @id @default(uuid())
  property_id                String
  customer_id                String
  worker_id                  String
  cleaning_job_id            String?
  issue_type                 String              @db.VarChar(50)
  title                      String              @db.VarChar(255)
  issue_description          String
  category                   String              @db.VarChar(50)
  priority                   String              @db.VarChar(20)
  photos                     String[]            @db.VarChar(500)
  status                     WorkerIssueStatus   @default(SUBMITTED)
  created_maintenance_job_id String?
  customer_response          String?
  customer_approved_at       DateTime?
  customer_rejected_at       DateTime?
  rejection_reason           String?
  reported_at                DateTime            @default(now())
  triaged_at                 DateTime?
  resolved_at                DateTime?
  created_at                 DateTime            @default(now())
  updated_at                 DateTime            @updatedAt
  property                   CustomerProperty    @relation(fields: [property_id], references: [id])
  customer                   Customer            @relation(fields: [customer_id], references: [id])
  worker                     Worker              @relation(fields: [worker_id], references: [id])
  cleaning_job               CleaningJob?        @relation(fields: [cleaning_job_id], references: [id])
  created_maintenance_job    MaintenanceJob?     @relation("WorkerIssueMaintenanceJob", fields: [created_maintenance_job_id], references: [id])

  @@index([property_id])
  @@index([customer_id])
  @@index([worker_id])
  @@index([cleaning_job_id])
  @@index([status])
  @@map("worker_issue_reports")
}

model PropertyShare {
  id                    String    @id @default(uuid())
  property_id           String
  owner_tenant_id       String
  shared_with_tenant_id String
  share_type            ShareType
  can_view              Boolean   @default(true)
  can_edit              Boolean   @default(false)
  can_view_financial    Boolean   @default(false)
  can_view_certificates Boolean   @default(true)
  can_create_jobs       Boolean   @default(true)
  can_view_tenants      Boolean   @default(false)
  is_active             Boolean   @default(true)
  shared_at             DateTime  @default(now())
  revoked_at            DateTime?
  notes                 String?
  owner_tenant          Tenant    @relation("SharedProperties", fields: [owner_tenant_id], references: [id])
  property              Property  @relation(fields: [property_id], references: [id], onDelete: Cascade)
  recipient             Tenant    @relation("ReceivedProperties", fields: [shared_with_tenant_id], references: [id])

  @@unique([property_id, shared_with_tenant_id])
  @@index([owner_tenant_id])
  @@index([shared_with_tenant_id])
  @@index([property_id])
  @@map("property_shares")
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  PAUSED
  CANCELLED
}

enum UserRole {
  ADMIN
  MEMBER
  CONTRACTOR
}

enum PropertyType {
  HOUSE
  FLAT
  COTTAGE
  COMMERCIAL
}

enum PropertyStatus {
  ACTIVE
  INACTIVE
}

enum WorkOrderStatus {
  OPEN
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum WorkOrderPriority {
  HIGH
  MEDIUM
  LOW
}

enum WorkOrderCategory {
  PLUMBING
  ELECTRICAL
  HEATING
  APPLIANCES
  EXTERIOR
  INTERIOR
  OTHER
}

enum PhotoLabel {
  BEFORE
  DURING
  AFTER
  PROPERTY
}

enum CertificateType {
  GAS_SAFETY
  ELECTRICAL
  EPC
  STL_LICENSE
  OTHER
}

enum DevicePlatform {
  IOS
  ANDROID
}

enum NotificationType {
  CERTIFICATE_EXPIRY
  PHOTO_QUALITY
  WORK_ORDER_ASSIGNED
  SUBSCRIPTION_ENDING
  PAYMENT_FAILED
  SYSTEM_ANNOUNCEMENT
  LEASE_EXPIRING
  RENT_OVERDUE
  BUDGET_ALERT
  MAINTENANCE_JOB_SCHEDULED
  MAINTENANCE_JOB_COMPLETED
  QUOTE_READY
}

enum TenantStatus {
  ACTIVE
  INACTIVE
  NOTICE_GIVEN
}

enum RentFrequency {
  WEEKLY
  MONTHLY
  QUARTERLY
}

enum PaymentMethod {
  BANK_TRANSFER
  CASH
  CHEQUE
  STANDING_ORDER
  OTHER
}

enum TransactionType {
  INCOME
  EXPENSE
}

enum ExpenseCategory {
  MAINTENANCE
  REPAIRS
  UTILITIES
  INSURANCE
  PROPERTY_TAX
  MANAGEMENT_FEES
  MORTGAGE
  LEGAL_FEES
  CLEANING
  GARDENING
  SAFETY_CERTIFICATES
  OTHER
}

enum ServiceType {
  CLEANING
  MAINTENANCE
}

enum PricingModel {
  PER_JOB
  HOURLY
  RETAINER
  CUSTOM
}

enum CustomerType {
  LANDLORD
  LETTING_AGENT
  PROPERTY_MANAGEMENT
  OFFICE_MANAGEMENT
  SHORT_LET_MANAGEMENT
  HOLIDAY_LETS
  COMMERCIAL
  // Legacy types (kept for backwards compatibility)
  PROPERTY_MANAGER
  OWNER
  LETTING_AGENCY
}

enum PaymentTerms {
  NET_7
  NET_14
  NET_30
}

enum WorkerType {
  CLEANER
  MAINTENANCE
  BOTH
}

enum EmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACTOR
}

enum WorkerAvailabilityStatus {
  BLOCKED
  AVAILABLE
}

enum JobStatus {
  PENDING // Job created but not yet scheduled
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum MaintenanceSource {
  CUSTOMER_REQUEST
  CLEANER_REPORT
  GUEST_REPORT
  PREVENTIVE_MAINTENANCE
  EMERGENCY
}

enum MaintenancePriority {
  URGENT
  HIGH
  MEDIUM
  LOW
}

enum MaintenanceStatus {
  QUOTE_PENDING
  QUOTE_SENT
  APPROVED
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum QuoteStatus {
  DRAFT
  SENT
  APPROVED
  DECLINED
  EXPIRED
}

enum InvoiceStatus {
  PENDING
  SENT
  PAID
  OVERDUE
  CANCELLED
}

enum GuestIssueStatus {
  SUBMITTED
  TRIAGED
  WORK_ORDER_CREATED
  RESOLVED
  DISMISSED
}

enum WorkerIssueStatus {
  SUBMITTED
  CUSTOMER_REVIEWING
  APPROVED
  REJECTED
  WORK_ORDER_CREATED
  RESOLVED
}

enum ShareType {
  CLEANING_SERVICE
  MAINTENANCE_SERVICE
  PROPERTY_MANAGEMENT
  GENERAL
}

enum ContractStatus {
  ACTIVE
  PAUSED
  CANCELLED
}

enum ContractType {
  FLAT_MONTHLY
  PER_PROPERTY
}

// ============================================================================
// PHASE 2.5: CUSTOMER PORTAL & GUEST AI DASHBOARD
// ============================================================================

// Customer Portal - Authentication and Preferences
model CustomerPortalUser {
  id               String    @id @default(uuid())
  customer_id      String    @unique
  email            String    @unique @db.VarChar(255)
  password_hash    String    @db.VarChar(255)
  last_login       DateTime?
  theme_preference String    @default("light")
  language         String    @default("en")
  created_at       DateTime  @default(now())
  updated_at       DateTime  @updatedAt

  customer      Customer               @relation(fields: [customer_id], references: [id], onDelete: Cascade)
  notifications CustomerNotification[]

  @@index([customer_id])
  @@index([email])
  @@map("customer_portal_users")
}

model CustomerNotification {
  id                      String           @id @default(uuid())
  customer_portal_user_id String
  notification_type       NotificationType
  title                   String           @db.VarChar(255)
  body                    String
  data                    Json?
  sent_at                 DateTime         @default(now())
  read_at                 DateTime?

  customer_portal_user CustomerPortalUser @relation(fields: [customer_portal_user_id], references: [id], onDelete: Cascade)

  @@index([customer_portal_user_id, read_at])
  @@map("customer_notifications")
}

model CustomerPreferences {
  id                       String   @id @default(uuid())
  customer_id              String   @unique
  auto_pay_enabled         Boolean  @default(false)
  notification_email       Boolean  @default(true)
  notification_sms         Boolean  @default(false)
  calendar_sync_enabled    Boolean  @default(false)
  quote_auto_approve_limit Float?
  created_at               DateTime @default(now())
  updated_at               DateTime @updatedAt

  customer Customer @relation(fields: [customer_id], references: [id], onDelete: Cascade)

  @@index([customer_id])
  @@map("customer_preferences")
}

// Guest AI Dashboard - Sessions and Interactions
model GuestSession {
  id                 String    @id @default(uuid())
  property_id        String
  device_id          String?
  session_start      DateTime  @default(now())
  session_end        DateTime?
  interactions_count Int       @default(0)

  property  CustomerProperty @relation(fields: [property_id], references: [id], onDelete: Cascade)
  questions GuestQuestion[]
  issues    GuestIssue[]

  @@index([property_id])
  @@index([session_start])
  @@map("guest_sessions")
}

model GuestQuestion {
  id             String   @id @default(uuid())
  session_id     String
  question       String   @db.Text
  answer         String   @db.Text
  answered_by    String   @db.VarChar(20) // 'AI' or 'human'
  confidence     Float?
  helpful_rating Int? // 1-5
  created_at     DateTime @default(now())

  session GuestSession @relation(fields: [session_id], references: [id], onDelete: Cascade)

  @@index([session_id])
  @@index([created_at])
  @@map("guest_questions")
}

model GuestIssue {
  id                    String    @id @default(uuid())
  session_id            String
  category              String    @db.VarChar(50)
  description           String    @db.Text
  severity              String    @db.VarChar(20) // 'critical', 'high', 'medium', 'low'
  ai_confidence         Float
  photos                Json? // Array of photo URLs
  recommended_action    String    @db.VarChar(50) // 'diy', 'send_tech', 'notify_manager'
  guest_selected_action String?   @db.VarChar(50)
  maintenance_job_id    String?
  resolved_at           DateTime?
  created_at            DateTime  @default(now())

  session         GuestSession    @relation(fields: [session_id], references: [id], onDelete: Cascade)
  maintenance_job MaintenanceJob? @relation(fields: [maintenance_job_id], references: [id])
  assessment      AIAssessment?
  diy_attempts    DIYAttempt[]

  @@index([session_id])
  @@index([maintenance_job_id])
  @@index([created_at])
  @@map("guest_issues")
}

model AIAssessment {
  id             String   @id @default(uuid())
  issue_id       String   @unique
  diagnosis      String   @db.Text
  confidence     Float
  severity       String   @db.VarChar(20)
  estimated_cost Float?
  estimated_time Int? // minutes
  created_at     DateTime @default(now())

  issue GuestIssue @relation(fields: [issue_id], references: [id], onDelete: Cascade)

  @@index([issue_id])
  @@map("ai_assessments")
}

model DIYGuide {
  id             String   @id @default(uuid())
  issue_type     String   @db.VarChar(100)
  title          String   @db.VarChar(200)
  steps          Json // Array of step objects
  video_url      String?  @db.VarChar(500)
  difficulty     String   @db.VarChar(20) // 'easy', 'medium', 'hard'
  estimated_time Int // minutes
  success_rate   Float?
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt

  attempts DIYAttempt[]

  @@index([issue_type])
  @@map("diy_guides")
}

model DIYAttempt {
  id         String   @id @default(uuid())
  issue_id   String
  guide_id   String
  successful Boolean
  time_spent Int? // seconds
  escalated  Boolean  @default(false)
  feedback   String?  @db.Text
  created_at DateTime @default(now())

  issue GuestIssue @relation(fields: [issue_id], references: [id], onDelete: Cascade)
  guide DIYGuide   @relation(fields: [guide_id], references: [id])

  @@index([issue_id])
  @@index([guide_id])
  @@map("diy_attempts")
}

model PropertyKnowledgeBase {
  id          String   @id @default(uuid())
  property_id String
  category    String   @db.VarChar(100)
  title       String   @db.VarChar(200)
  content     String   @db.Text
  video_url   String?  @db.VarChar(500)
  pdf_url     String?  @db.VarChar(500)
  embedding   Json? // Vector for RAG
  view_count  Int      @default(0)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  property CustomerProperty @relation(fields: [property_id], references: [id], onDelete: Cascade)

  @@index([property_id])
  @@index([category])
  @@map("property_knowledge_base")
}

model LocalRecommendation {
  id                   String   @id @default(uuid())
  category             String   @db.VarChar(50) // 'restaurant', 'attraction', 'grocery', etc.
  name                 String   @db.VarChar(200)
  description          String   @db.Text
  address              String?  @db.VarChar(500)
  distance_description String?  @db.VarChar(100) // "5 min drive"
  rating               Float?
  reviews_count        Int?
  map_url              String?  @db.VarChar(500)
  phone                String?  @db.VarChar(20)
  website              String?  @db.VarChar(500)
  created_at           DateTime @default(now())
  updated_at           DateTime @updatedAt

  @@index([category])
  @@map("local_recommendations")
}

// ============================================================================
// PHASE 3: CLEANING CONTRACT-BASED WORKFLOW
// ============================================================================

model CleaningContract {
  id                     String         @id @default(uuid())
  contract_number        String?        @unique @db.VarChar(50)
  customer_id            String
  service_provider_id    String
  contract_type          ContractType   @default(FLAT_MONTHLY)
  contract_start_date    DateTime       @db.Date
  contract_end_date      DateTime?      @db.Date
  monthly_fee            Decimal        @db.Decimal(10, 2)
  billing_day            Int // 1-31, day of month to invoice
  status                 ContractStatus @default(ACTIVE)
  notes                  String?
  customer_address_line1 String?        @db.VarChar(255)
  customer_address_line2 String?        @db.VarChar(255)
  customer_city          String?        @db.VarChar(100)
  customer_postcode      String?        @db.VarChar(20)
  customer_country       String?        @db.VarChar(100)
  created_at             DateTime       @default(now())
  updated_at             DateTime       @updatedAt

  customer           Customer           @relation(fields: [customer_id], references: [id])
  cleaning_jobs      CleaningJob[]
  invoices           CleaningInvoice[]
  property_contracts ContractProperty[]
  files              ContractFile[]

  @@index([customer_id])
  @@index([service_provider_id])
  @@index([status])
  @@map("cleaning_contracts")
}

model ContractProperty {
  id                   String   @id @default(uuid())
  contract_id          String
  property_id          String
  property_monthly_fee Decimal? @db.Decimal(10, 2) // For PER_PROPERTY pricing
  is_active            Boolean  @default(true)
  created_at           DateTime @default(now())

  contract CleaningContract @relation(fields: [contract_id], references: [id], onDelete: Cascade)
  property CustomerProperty @relation(fields: [property_id], references: [id])

  @@unique([contract_id, property_id])
  @@index([contract_id])
  @@index([property_id])
  @@map("contract_properties")
}

model ContractFile {
  id           String   @id @default(uuid())
  contract_id  String
  file_name    String
  file_path    String
  file_type    String // MIME type (image/png, application/pdf, etc.)
  file_size    Int // Size in bytes
  description  String? // Optional description of the file
  uploaded_by  String? // User ID who uploaded
  created_at   DateTime @default(now())

  contract CleaningContract @relation(fields: [contract_id], references: [id], onDelete: Cascade)

  @@index([contract_id])
  @@map("contract_files")
}

model CleaningJobTimesheet {
  id                        String    @id @default(uuid())
  cleaning_job_id           String
  worker_id                 String
  work_performed            String?   @db.Text
  checklist_items_completed Json? // Array of completed checklist items
  start_time                DateTime
  end_time                  DateTime?
  total_hours               Decimal?  @db.Decimal(10, 2)
  before_photos             String[]  @db.VarChar(500)
  after_photos              String[]  @db.VarChar(500)
  issue_photos              String[]  @db.VarChar(500)
  notes                     String?   @db.Text
  created_at                DateTime  @default(now())
  updated_at                DateTime  @updatedAt

  cleaning_job CleaningJob @relation(fields: [cleaning_job_id], references: [id], onDelete: Cascade)
  worker       Worker      @relation(fields: [worker_id], references: [id])

  @@index([cleaning_job_id])
  @@index([worker_id])
  @@index([start_time])
  @@map("cleaning_job_timesheets")
}

model CleaningInvoice {
  id                     String        @id @default(uuid())
  contract_id            String
  customer_id            String
  invoice_number         String        @unique @db.VarChar(50)
  billing_period_start   DateTime      @db.Date
  billing_period_end     DateTime      @db.Date
  total_cleans_completed Int           @default(0)
  contract_monthly_fee   Decimal       @db.Decimal(10, 2)
  additional_charges     Decimal       @default(0) @db.Decimal(10, 2)
  subtotal               Decimal       @db.Decimal(10, 2)
  tax_percentage         Decimal       @default(20) @db.Decimal(5, 2)
  tax_amount             Decimal       @db.Decimal(10, 2)
  total_amount           Decimal       @db.Decimal(10, 2)
  status                 InvoiceStatus @default(PENDING)
  due_date               DateTime      @db.Date
  paid_at                DateTime?
  payment_method         String?       @db.VarChar(50)
  payment_reference      String?       @db.VarChar(100)
  notes                  String?
  created_at             DateTime      @default(now())
  updated_at             DateTime      @updatedAt

  contract CleaningContract @relation(fields: [contract_id], references: [id])
  customer Customer         @relation(fields: [customer_id], references: [id])

  @@index([contract_id])
  @@index([customer_id])
  @@index([status])
  @@index([billing_period_start])
  @@index([billing_period_end])
  @@map("cleaning_invoices")
}

model CleaningQuote {
  id                  String      @id @default(uuid())
  customer_id         String
  property_id         String?
  cleaning_job_id     String?
  quote_number        String      @unique @db.VarChar(50)
  quote_date          DateTime    @db.Date
  valid_until_date    DateTime    @db.Date
  line_items          Json
  subtotal            Decimal     @db.Decimal(10, 2)
  discount_percentage Decimal     @default(0) @db.Decimal(5, 2)
  discount_amount     Decimal     @default(0) @db.Decimal(10, 2)
  total               Decimal     @db.Decimal(10, 2)
  status              QuoteStatus @default(DRAFT)
  customer_response   String?
  approved_at         DateTime?
  notes               String?
  created_at          DateTime    @default(now())
  updated_at          DateTime    @updatedAt

  customer Customer          @relation(fields: [customer_id], references: [id])
  property CustomerProperty? @relation(fields: [property_id], references: [id])

  @@index([customer_id])
  @@index([property_id])
  @@index([status])
  @@map("cleaning_quotes")
}

model PropertyCalendar {
  id                          String   @id @default(uuid())
  property_id                 String
  guest_checkout_datetime     DateTime
  next_guest_checkin_datetime DateTime
  clean_window_start          DateTime // Calculated from checkout
  clean_window_end            DateTime // Calculated from checkin
  cleaning_job_id             String?
  notes                       String?  @db.Text
  created_at                  DateTime @default(now())
  updated_at                  DateTime @updatedAt

  property CustomerProperty @relation(fields: [property_id], references: [id], onDelete: Cascade)

  @@index([property_id])
  @@index([guest_checkout_datetime])
  @@index([next_guest_checkin_datetime])
  @@map("property_calendars")
}

// ============================================================================
// JOB HISTORY & AUDIT TRAIL
// ============================================================================

model CleaningJobHistory {
  id                 String               @id @default(uuid())
  cleaning_job_id    String
  changed_by_user_id String? // User who made the change (can be null for system changes)
  changed_at         DateTime             @default(now())
  change_type        JobHistoryChangeType
  field_name         String?              @db.VarChar(100) // Which field changed (e.g., "assigned_worker_id", "scheduled_date")
  old_value          String?              @db.Text // Previous value (JSON string or simple value)
  new_value          String?              @db.Text // New value (JSON string or simple value)
  description        String?              @db.VarChar(500) // Human-readable description (e.g., "Worker changed from John to Sarah")
  metadata           Json? // Additional context (IP address, user agent, etc.)

  cleaning_job CleaningJob @relation(fields: [cleaning_job_id], references: [id], onDelete: Cascade)

  @@index([cleaning_job_id])
  @@index([changed_at])
  @@index([change_type])
  @@map("cleaning_job_history")
}

enum JobHistoryChangeType {
  CREATED // Job was created
  UPDATED // General update
  STATUS_CHANGED // Status field changed
  WORKER_ASSIGNED // Worker assigned (from null)
  WORKER_CHANGED // Worker changed (from one to another)
  WORKER_UNASSIGNED // Worker removed (to null)
  TIME_CHANGED // Start or end time changed
  DATE_CHANGED // Scheduled date changed
  CHECKLIST_UPDATED // Checklist modified
  PHOTO_ADDED // Photo uploaded
  NOTES_UPDATED // Completion notes or other notes changed
  PRICE_CHANGED // Price modified
  MAINTENANCE_ISSUE_CREATED // Maintenance issue reported from this job
  DELETED // Job marked as deleted
}

// ============================================================================
// PROPERTY HISTORY & ACTIVITY LOG
// ============================================================================

model PropertyHistory {
  id                 String                    @id @default(uuid())
  property_id        String
  changed_by_user_id String? // User who made the change (can be null for system changes)
  changed_at         DateTime                  @default(now())
  change_type        PropertyHistoryChangeType
  field_name         String?                   @db.VarChar(100) // Which field changed
  old_value          String?                   @db.Text // Previous value
  new_value          String?                   @db.Text // New value
  description        String?                   @db.VarChar(500) // Human-readable description
  metadata           Json? // Additional context (job IDs, contract IDs, etc.)

  // No foreign key - allows tracking any property from any table (properties, customer_properties, etc.)

  @@index([property_id])
  @@index([changed_at])
  @@index([change_type])
  @@map("property_history")
}

enum PropertyHistoryChangeType {
  PROPERTY_CREATED // Property was created
  PROPERTY_UPDATED // Property details updated
  ACCESS_INSTRUCTIONS_UPDATED // Access instructions changed
  STATUS_CHANGED // Property status changed

  // Cleaning events
  CLEANING_JOB_SCHEDULED // Cleaning job scheduled for property
  CLEANING_JOB_STARTED // Cleaning job started
  CLEANING_JOB_COMPLETED // Cleaning job completed
  CLEANING_JOB_CANCELLED // Cleaning job cancelled

  // Maintenance events
  MAINTENANCE_JOB_CREATED // Maintenance job created
  MAINTENANCE_JOB_SCHEDULED // Maintenance job scheduled
  MAINTENANCE_JOB_COMPLETED // Maintenance job completed
  MAINTENANCE_JOB_CANCELLED // Maintenance job cancelled

  // Contract events
  CONTRACT_CREATED // Cleaning contract created
  CONTRACT_RENEWED // Contract renewed
  CONTRACT_UPDATED // Contract terms updated
  CONTRACT_CANCELLED // Contract cancelled

  // Certificate events
  CERTIFICATE_UPLOADED // New certificate uploaded
  CERTIFICATE_EXPIRING_SOON // Certificate expiring soon (auto)
  CERTIFICATE_EXPIRED // Certificate expired (auto)
  CERTIFICATE_RENEWED // Certificate renewed

  // Other events
  PHOTO_UPLOADED // Property photo uploaded
  TENANT_MOVED_IN // New tenant moved in
  TENANT_MOVED_OUT // Tenant moved out
  WORK_ORDER_CREATED // Work order created
  WORK_ORDER_COMPLETED // Work order completed
}

// ============================================================================
// WORKER HISTORY & ACTIVITY LOG
// ============================================================================

model WorkerHistory {
  id                 String                  @id @default(uuid())
  worker_id          String
  changed_by_user_id String? // Admin who made the change (can be null for system changes)
  changed_at         DateTime                @default(now())
  change_type        WorkerHistoryChangeType
  field_name         String?                 @db.VarChar(100) // Which field changed
  old_value          String?                 @db.Text // Previous value
  new_value          String?                 @db.Text // New value
  description        String?                 @db.VarChar(500) // Human-readable description
  metadata           Json? // Additional context (job IDs, property names, etc.)

  worker Worker @relation(fields: [worker_id], references: [id], onDelete: Cascade)

  @@index([worker_id])
  @@index([changed_at])
  @@index([change_type])
  @@map("worker_history")
}

enum WorkerHistoryChangeType {
  // Profile events
  WORKER_CREATED // Worker account created
  PROFILE_UPDATED // Basic profile fields changed
  PHOTO_UPLOADED // Profile photo added/changed
  CONTACT_INFO_UPDATED // Phone, email changed
  RATE_CHANGED // Hourly rate modified
  STATUS_CHANGED // Active/inactive status

  // Job events
  JOB_ASSIGNED // Assigned to a job (cleaning or maintenance)
  JOB_REASSIGNED // Job reassigned to different worker
  JOB_UNASSIGNED // Removed from a job
  JOB_STARTED // Worker started a job
  JOB_COMPLETED // Worker completed a job
  JOB_CANCELLED // Assigned job was cancelled

  // Certificate events
  CERTIFICATE_UPLOADED // New certificate added
  CERTIFICATE_RENEWED // Certificate renewed
  CERTIFICATE_EXPIRING // Certificate expiring soon (auto-generated)
  CERTIFICATE_EXPIRED // Certificate expired (auto-generated)
  CERTIFICATE_REMOVED // Certificate deleted

  // Availability events
  AVAILABILITY_UPDATED // Working hours/days changed
  TIME_OFF_REQUESTED // PTO/vacation requested
  TIME_OFF_APPROVED // Time off approved
  TIME_OFF_DECLINED // Time off declined

  // Performance events
  RATING_RECEIVED // Customer rating received
  MILESTONE_REACHED // 10th job, 50th job, 100th job, etc.
  COMPLAINT_FILED // Customer complaint
  COMMENDATION_RECEIVED // Positive feedback/commendation

  // Other
  NOTE_ADDED // Admin note added to worker profile
  EMERGENCY_CONTACT_UPDATED // Emergency contact information updated
}
